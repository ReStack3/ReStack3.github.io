

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Ling">
  <meta name="keywords" content="">
  
    <meta name="description" content="为什么要启动frida-server? sequenceDiagram     Client-&gt;&gt;+ADB: 建立端口转发 (adb forward tcp:27042 tcp:27042)     Client-&gt;&gt;frida-server: 通过本地端口连接     frida-server-&gt;&gt;Client: 返回连接确认     Client-&gt;">
<meta property="og:type" content="article">
<meta property="og:title" content="The Peak Tower">
<meta property="og:url" content="http://example.com/2025/05/09/%E9%80%86%E5%90%91%E4%B8%8E%E9%A3%8E%E6%8E%A7/Android%E5%B9%B3%E5%8F%B0/%E9%80%86%E5%90%91/Hook%E6%8A%80%E6%9C%AF/Frida/Frida%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="The Peak Tower">
<meta property="og:description" content="为什么要启动frida-server? sequenceDiagram     Client-&gt;&gt;+ADB: 建立端口转发 (adb forward tcp:27042 tcp:27042)     Client-&gt;&gt;frida-server: 通过本地端口连接     frida-server-&gt;&gt;Client: 返回连接确认     Client-&gt;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2025/04/11/jGkr6N8shF7Ylip.png">
<meta property="article:published_time" content="2025-05-09T07:31:42.523Z">
<meta property="article:modified_time" content="2025-05-09T13:04:35.838Z">
<meta property="article:author" content="Ling">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://s2.loli.net/2025/04/11/jGkr6N8shF7Ylip.png">
  
  
  
  <title>The Peak Tower</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text=""></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-05-09 15:31" pubdate>
          2025年5月9日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          48 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header"></h1>
            
            
              <div class="markdown-body">
                
                <p><img src="https://s2.loli.net/2025/04/11/jGkr6N8shF7Ylip.png" srcset="/img/loading.gif" lazyload></p>
<p>为什么要启动frida-server?</p>
<pre><code class=" mermaid">sequenceDiagram
    Client-&gt;&gt;+ADB: 建立端口转发 (adb forward tcp:27042 tcp:27042)
    Client-&gt;&gt;frida-server: 通过本地端口连接
    frida-server-&gt;&gt;Client: 返回连接确认
    Client-&gt;&gt;frida-server: 协商协议版本
    frida-server-&gt;&gt;Client: 返回设备信息
</code></pre>



<p>frida-server启动后会做些什么？</p>
<p>frida的两种模式的区别？</p>
<h1 id="frida-server"><a href="#frida-server" class="headerlink" title="frida-server"></a>frida-server</h1><figure class="highlight v"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs v">#<span class="hljs-keyword">if</span> DARWIN<br>		<span class="hljs-comment">// 创建一个线程，线程名为&quot;frida-server-main-loop&quot;，线程执行的任务为run_application函数</span><br>		<span class="hljs-keyword">var</span> worker = <span class="hljs-keyword">new</span> Thread&lt;<span class="hljs-keyword">int</span>&gt; (<span class="hljs-string">&quot;frida-server-main-loop&quot;</span>, () =&gt; &#123;<br>			<span class="hljs-comment">// 执行run_application函数，获取退出码</span><br>			<span class="hljs-keyword">var</span> exit_code = run_application (endpoint_params, options, on_ready);<br>			<span class="hljs-comment">// 停止运行循环</span><br>			_stop_run_loop ();<br>			<span class="hljs-comment">// 返回退出码</span><br>			<span class="hljs-keyword">return</span> exit_code;<br>		&#125;);<br>		<span class="hljs-comment">// 启动运行循环</span><br>		_start_run_loop ();<br>		<span class="hljs-comment">// 等待线程执行完毕，获取退出码</span><br>		<span class="hljs-keyword">var</span> exit_code = worker<span class="hljs-variable">.join</span> ();<br>		<span class="hljs-comment">// 返回退出码</span><br>		<span class="hljs-keyword">return</span> exit_code;<br>#<span class="hljs-keyword">else</span><br>		<span class="hljs-comment">// 非DARWIN平台，直接执行run_application函数，返回退出码</span><br>		<span class="hljs-keyword">return</span> run_application (endpoint_params, options, on_ready);<br>#endif<br></code></pre></td></tr></table></figure>



<figure class="highlight v"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs v">private <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> run_application (EndpointParameters endpoint_params, ControlServiceOptions options, ReadyHandler on_ready) &#123;<br>	......<br>	application = <span class="hljs-keyword">new</span> Application (<span class="hljs-keyword">new</span> ControlService (endpoint_params, options));<br>	<span class="hljs-comment">// 当接收到SIGINT信号时，停止application</span><br>	Posix<span class="hljs-variable">.signal</span> (Posix<span class="hljs-variable">.Signal</span><span class="hljs-variable">.INT</span>, (sig) =&gt; &#123;<br>		application<span class="hljs-variable">.stop</span> ();<br>	&#125;);<br>	<span class="hljs-comment">// 当接收到SIGTERM信号时，停止application</span><br>	Posix<span class="hljs-variable">.signal</span> (Posix<span class="hljs-variable">.Signal</span><span class="hljs-variable">.TERM</span>, (sig) =&gt; &#123;<br>		application<span class="hljs-variable">.stop</span> ();<br>	&#125;);<br>	<span class="hljs-comment">// 如果on_ready不为空，则连接application的ready信号，当ready信号发出时，调用on_ready函数</span><br>	<span class="hljs-keyword">if</span> (on_ready != <span class="hljs-literal">null</span>) &#123;<br>		application<span class="hljs-variable">.ready</span><span class="hljs-variable">.connect</span> (success =&gt; &#123;<br>			on_ready (success);<br>			on_ready = <span class="hljs-literal">null</span>;<br>		&#125;);<br>	&#125;<br>	<span class="hljs-comment">// 运行application，并返回运行结果</span><br>	<span class="hljs-keyword">return</span> application<span class="hljs-variable">.run</span> ();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主要这里的<code>ControlService</code>是Frida 的核心服务，主要负责：</p>
<ul>
<li><p>管理客户端连接（如 <code>frida -R</code> 的请求）。</p>
</li>
<li><p>处理进程注入（<code>attach</code>&#x2F;<code>spawn</code>）。</p>
</li>
<li><p>中转脚本和 Hook 结果。</p>
</li>
<li><p><strong>用户关联</strong>：用户的所有客户端操作（如注入脚本、调用 RPC）最终由 <code>ControlService</code> 执行。</p>
</li>
</ul>
<figure class="highlight v"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs v"><span class="hljs-comment">// 运行程序</span><br>public <span class="hljs-keyword">int</span> run () &#123;<br>	<span class="hljs-comment">// 添加一个空闲事件，当空闲时开始执行start.begin()方法</span><br>	Idle<span class="hljs-variable">.add</span> (() =&gt; &#123;<br>		start<span class="hljs-variable">.begin</span> ();<br>		<span class="hljs-keyword">return</span> false;<br>	&#125;);<br>	<span class="hljs-comment">// 设置退出码为0</span><br>	exit_code = <span class="hljs-number">0</span>;<br>	<span class="hljs-comment">// 运行事件循环</span><br>	loop<span class="hljs-variable">.run</span> ();<br>	<span class="hljs-comment">// 返回退出码</span><br>	<span class="hljs-keyword">return</span> exit_code;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>service.start[ControlService.start]—- service.start[WebService.start]</p>
<figure class="highlight v"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs v"><span class="hljs-comment">// 开始函数，异步执行，抛出Error和IOError异常</span><br>public async <span class="hljs-keyword">void</span> start (Cancellable? cancellable) throws Error, IOError &#123;<br>	<span class="hljs-comment">// 获取当前线程的MainContext</span><br>	frida_context = MainContext<span class="hljs-variable">.ref_thread_default</span> ();<br>	<span class="hljs-comment">// 获取DBus上下文</span><br>	dbus_context = yield get_dbus_context ();<br>	<span class="hljs-comment">// 如果取消，则设置错误</span><br>	cancellable<span class="hljs-variable">.set_error_if_cancelled</span> ();<br>	<span class="hljs-comment">// 创建一个Promise对象，用于存储启动请求的SocketAddress</span><br>	<span class="hljs-keyword">var</span> start_request = <span class="hljs-keyword">new</span> Promise&lt;SocketAddress&gt; ();<br>	<span class="hljs-comment">// 在DBus线程上调度一个函数，该函数开始处理启动请求</span><br>	schedule_on_dbus_thread (() =&gt; &#123;<br>		handle_start_request<span class="hljs-variable">.begin</span> (start_request, cancellable);<br>		<span class="hljs-keyword">return</span> false;<br>	&#125;);<br>	<span class="hljs-comment">// 等待启动请求完成，并获取监听地址</span><br>	_listen_address = yield start_request<span class="hljs-variable">.future</span><span class="hljs-variable">.wait_async</span> (cancellable);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>WebService.handle_start_request—-WebService.do_start</p>
<p>其中<code>do_start</code> 是用于 <strong>异步启动网络服务</strong> 的核心逻辑，主要功能是：</p>
<ol>
<li><strong>创建服务器</strong>（如 TCP 或 Unix Socket 服务）。</li>
<li><strong>解析监听地址</strong>（根据 <code>flavor</code> 类型解析控制地址或集群地址）。</li>
<li><strong>绑定到可用地址</strong>（遍历所有可能的地址，直到成功监听）。</li>
<li><strong>处理动态网络接口变化</strong>（如 Wi-Fi 切换时重新绑定）。</li>
</ol>
<p>WebService.on_websocket_opened  —WebService.construct  —Service[WebService].incoming.connect (on_server_connection)—-WebService.handle_server_connection</p>
<figure class="highlight v"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs v"><span class="hljs-comment">// 处理服务器连接</span><br>private async <span class="hljs-keyword">void</span> handle_server_connection (IOStream raw_connection) throws GLib<span class="hljs-variable">.Error</span> &#123;<br>	<span class="hljs-comment">// 创建DBus连接</span><br>	<span class="hljs-keyword">var</span> connection = yield <span class="hljs-keyword">new</span> DBusConnection (raw_connection, <span class="hljs-literal">null</span>, DELAY_MESSAGE_PROCESSING, <span class="hljs-literal">null</span>, io_cancellable);<br>	<span class="hljs-comment">// 连接关闭时调用on_connection_closed函数</span><br>	connection<span class="hljs-variable">.on_closed</span><span class="hljs-variable">.connect</span> (on_connection_closed);<br>	<span class="hljs-comment">// 创建Peer对象</span><br>	Peer peer;<br>	<span class="hljs-comment">// 如果有认证服务，则创建AuthenticationChannel对象</span><br>	AuthenticationService? auth_service = endpoint_params<span class="hljs-variable">.auth_service</span>;<br>	<span class="hljs-keyword">if</span> (auth_service != <span class="hljs-literal">null</span>)<br>		peer = <span class="hljs-keyword">new</span> AuthenticationChannel (<span class="hljs-keyword">this</span>, connection, auth_service);<br>	<span class="hljs-comment">// 否则调用setup_control_channel函数创建Peer对象</span><br>	<span class="hljs-keyword">else</span><br>		peer = setup_control_channel (connection);<br>	<span class="hljs-comment">// 将Peer对象添加到peers字典中</span><br>	peers[connection] = peer;<br>	<span class="hljs-comment">// 开始消息处理</span><br>	connection<span class="hljs-variable">.start_message_processing</span> ();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对于不需要认证的情况，将会调用 <code>setup_control_channel</code> 完成初始化，而该函数将会返回一个 <code>ControlChannel</code> 对象，其构造函数如下：</p>
<figure class="highlight v"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs v">construct &#123;<br>    try &#123;<br>        <span class="hljs-comment">// 1. 将当前 ControlChannel 对象注册为 D-Bus 的 HostSession 接口</span><br>        <span class="hljs-comment">// - ObjectPath.HOST_SESSION: 固定路径（如 &quot;/re/frida/HostSession&quot;）</span><br>        <span class="hljs-comment">// - session: 当前对象自身（ControlChannel 实现了 HostSession 接口）</span><br>        <span class="hljs-comment">// - 注册后，客户端可通过 D-Bus 调用进程附加、脚本加载等方法</span><br>        HostSession session = <span class="hljs-keyword">this</span>;<br>        registrations<span class="hljs-variable">.add</span> (connection<span class="hljs-variable">.register_object</span> (ObjectPath<span class="hljs-variable">.HOST_SESSION</span>, session));<br>        <span class="hljs-comment">// 2. 注册一个空认证服务（NullAuthenticationService）</span><br>        <span class="hljs-comment">// - 即使当前不需要认证，也保持接口一致性</span><br>        <span class="hljs-comment">// - Frida.ObjectPath.AUTHENTICATION_SERVICE: 固定路径（如 &quot;/re/frida/Auth&quot;）</span><br>        <span class="hljs-comment">// - 若启用认证，此处会替换为实际认证服务（如 TokenAuthenticationService）</span><br>        AuthenticationService null_auth = <span class="hljs-keyword">new</span> NullAuthenticationService ();<br>        registrations<span class="hljs-variable">.add</span> (connection<span class="hljs-variable">.register_object</span> (Frida<span class="hljs-variable">.ObjectPath</span><span class="hljs-variable">.AUTHENTICATION_SERVICE</span>, null_auth));<br>        <span class="hljs-comment">// 3. 将当前 ControlChannel 对象注册为 TransportBroker 接口</span><br>        <span class="hljs-comment">// - Frida.ObjectPath.TRANSPORT_BROKER: 固定路径（如 &quot;/re/frida/Transport&quot;）</span><br>        <span class="hljs-comment">// - broker: 当前对象自身（ControlChannel 实现了 TransportBroker 接口）</span><br>        <span class="hljs-comment">// - 用于处理大文件传输（如上传 .so 库或脚本文件）</span><br>        TransportBroker broker = <span class="hljs-keyword">this</span>;<br>        registrations<span class="hljs-variable">.add</span> (connection<span class="hljs-variable">.register_object</span> (Frida<span class="hljs-variable">.ObjectPath</span><span class="hljs-variable">.TRANSPORT_BROKER</span>, broker));<br><br>    &#125; catch (IOError e) &#123;<br>        <span class="hljs-comment">// 4. 异常处理：如果注册失败，直接终止程序</span><br>        <span class="hljs-comment">// - 正常情况下不应触发，若发生则表明严重错误（如 D-Bus 路径</span><br>        assert_not_reached ();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>该对象在构造时将会把 <code>HostSession</code> 、<code>AuthenticationService</code> 和 <code>TransportBroker</code> 都注册到 Dbus 对象中，这会使得远程的电脑端能够直接调用这些类中的方法从而实现通信。</p>
<p>其中<code>ControlChannel</code> 是 Frida 中 <strong>管理客户端与目标进程间核心通信的控制通道</strong>，主要负责以下关键任务：</p>
<table>
<thead>
<tr>
<th align="center"><strong>功能</strong></th>
<th align="center"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>暴露 D-Bus 接口</strong></td>
<td align="center">将 Frida 的核心服务（如 <code>HostSession</code>、<code>TransportBroker</code>）注册为 D-Bus 对象，供客户端远程调用。</td>
</tr>
<tr>
<td align="center"><strong>中转脚本与指令</strong></td>
<td align="center">处理客户端发送的脚本注入、RPC 调用等请求，并转发给 <code>frida-agent</code> 执行。</td>
</tr>
<tr>
<td align="center"><strong>管理数据传输</strong></td>
<td align="center">通过 <code>TransportBroker</code> 接口处理大文件传输（如上传动态库）。</td>
</tr>
<tr>
<td align="center"><strong>生命周期控制</strong></td>
<td align="center">管理连接的建立、维护和销毁（如客户端断开时清理资源）。</td>
</tr>
</tbody></table>
<p>而主要的负责通信的部分都由 <code>ControlChannel</code> 中的函数负责实现，常见的几个函数实现如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-built_in">uint</span> <span class="hljs-title">spawn</span> (<span class="hljs-params"><span class="hljs-built_in">string</span> program, HostSpawnOptions options, Cancellable? cancellable</span>) throws GLib.Error</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">yield</span> parent.host_session.spawn (program, options, cancellable);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">resume</span> (<span class="hljs-params"><span class="hljs-built_in">uint</span> pid, Cancellable? cancellable</span>) throws GLib.Error</span> &#123;<br>	<span class="hljs-keyword">yield</span> parent.resume (pid, <span class="hljs-keyword">this</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> AgentSessionId <span class="hljs-title">attach</span> (<span class="hljs-params"><span class="hljs-built_in">uint</span> pid, HashTable&lt;<span class="hljs-built_in">string</span>, Variant&gt; options,</span></span><br><span class="hljs-params"><span class="hljs-function">		Cancellable? cancellable</span>) throws GLib.Error</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">yield</span> parent.attach (pid, options, <span class="hljs-keyword">this</span>, cancellable);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="Linux-桌面环境下的服务暴露"><a href="#Linux-桌面环境下的服务暴露" class="headerlink" title="Linux 桌面环境下的服务暴露"></a><strong>Linux 桌面环境下的服务暴露</strong></h4><ul>
<li><strong>功能</strong>：<br>Frida 通过 D-Bus 将核心功能（如 <code>HostSession</code>、<code>TransportBroker</code>）注册为服务接口，供其他本地工具（如 GUI 调试器）调用。</li>
<li>示例接口：<ul>
<li>**<code>re.frida.HostSession</code>**：管理进程附加（<code>attach</code>）、启动（<code>spawn</code>）、脚本加载。</li>
<li>**<code>re.frida.TransportBroker</code>**：处理文件传输或共享内存管理。</li>
</ul>
</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// 异步方法，用于在指定路径下生成一个进程</span><br>		<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-built_in">uint</span> <span class="hljs-title">spawn</span> (<span class="hljs-params"><span class="hljs-built_in">string</span> path, HostSpawnOptions options, Cancellable? cancellable</span>) throws Error, IOError</span> &#123;<br>			<span class="hljs-comment">// 检查指定路径下是否存在可执行文件</span><br>			<span class="hljs-keyword">if</span> (!FileUtils.test (path, EXISTS))<br>				<span class="hljs-comment">// 如果不存在，抛出异常</span><br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error.EXECUTABLE_NOT_FOUND (<span class="hljs-string">&quot;Unable to find executable at &#x27;%s&#x27;&quot;</span>, path);<br><br>			<span class="hljs-comment">// 定义一个变量，用于存储进程的输入输出管道</span><br>			StdioPipes? pipes;<br>			<span class="hljs-comment">// 调用_spawn方法，生成进程，并返回进程的PID</span><br>			<span class="hljs-keyword">var</span> child_pid = _spawn (path, options, <span class="hljs-keyword">out</span> pipes);<br>			<span class="hljs-comment">// 添加进程监听器，当进程结束时调用on_child_dead方法</span><br>			ChildWatch.<span class="hljs-keyword">add</span> ((Pid) child_pid, on_child_dead);<br>			<span class="hljs-comment">// 如果进程的输入输出管道不为空</span><br>			<span class="hljs-keyword">if</span> (pipes != <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-comment">// 将进程的输入管道添加到stdin_streams中</span><br>				stdin_streams[child_pid] = <span class="hljs-keyword">new</span> UnixOutputStream (pipes.input, <span class="hljs-literal">false</span>);<br>				<span class="hljs-comment">// 调用process_next_output_from方法，处理进程的输出</span><br>				process_next_output_from.begin (<span class="hljs-keyword">new</span> UnixInputStream (pipes.output, <span class="hljs-literal">false</span>), child_pid, <span class="hljs-number">1</span>, pipes);<br>				<span class="hljs-comment">// 调用process_next_output_from方法，处理进程的错误输出</span><br>				process_next_output_from.begin (<span class="hljs-keyword">new</span> UnixInputStream (pipes.error, <span class="hljs-literal">false</span>), child_pid, <span class="hljs-number">2</span>, pipes);<br>			&#125;<br><br>			<span class="hljs-comment">// 返回进程的PID</span><br>			<span class="hljs-keyword">return</span> child_pid;<br>		&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// 重写perform_attach_to方法，异步返回IOStream</span><br>		<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Future&lt;IOStream&gt; <span class="hljs-title">perform_attach_to</span> (<span class="hljs-params"><span class="hljs-built_in">uint</span> pid, HashTable&lt;<span class="hljs-built_in">string</span>, Variant&gt; options,</span></span><br><span class="hljs-params"><span class="hljs-function">				Cancellable? cancellable, <span class="hljs-keyword">out</span> Object? transport</span>) throws Error, IOError</span> &#123;<br>			<span class="hljs-comment">// 定义id，entrypoint，parameters，features变量</span><br>			<span class="hljs-built_in">uint</span> id;<br>			<span class="hljs-built_in">string</span> entrypoint = <span class="hljs-string">&quot;frida_agent_main&quot;</span>;<br>			<span class="hljs-built_in">string</span> parameters = make_agent_parameters (pid, <span class="hljs-string">&quot;&quot;</span>, options);<br>			AgentFeatures features = CONTROL_CHANNEL;<br>			<span class="hljs-comment">// 将injector转换为Linjector类型</span><br>			<span class="hljs-keyword">var</span> linjector = (Linjector) injector;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> HAVE_EMBEDDED_ASSETS</span><br>			<span class="hljs-comment">// 如果有嵌入式资源，则调用inject_library_resource方法</span><br>			id = <span class="hljs-keyword">yield</span> linjector.inject_library_resource (pid, agent, entrypoint, parameters, features, cancellable);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>			<span class="hljs-comment">// 否则调用inject_library_file_with_template方法</span><br>			id = <span class="hljs-keyword">yield</span> linjector.inject_library_file_with_template (pid, PathTemplate (Config.FRIDA_AGENT_PATH), entrypoint,<br>				parameters, features, cancellable);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>			<span class="hljs-comment">// 将pid和id存入injectee_by_pid字典中</span><br>			injectee_by_pid[pid] = id;<br><br>			<span class="hljs-comment">// 创建Promise对象，用于异步返回IOStream</span><br>			<span class="hljs-keyword">var</span> stream_request = <span class="hljs-keyword">new</span> Promise&lt;IOStream&gt; ();<br>			<span class="hljs-comment">// 调用request_control_channel方法，获取IOStream</span><br>			IOStream stream = <span class="hljs-keyword">yield</span> linjector.request_control_channel (id, cancellable);<br>			<span class="hljs-comment">// 解析Promise对象，返回IOStream</span><br>			stream_request.resolve (stream);<br><br>			<span class="hljs-comment">// 将transport设置为null</span><br>			transport = <span class="hljs-literal">null</span>;<br><br>			<span class="hljs-comment">// 返回Promise对象的future</span><br>			<span class="hljs-keyword">return</span> stream_request.future;<br>		&#125;<br></code></pre></td></tr></table></figure>





<p>Frida 在某些场景下使用 <strong>D-Bus</strong>（特别是在 Linux 环境中）主要基于以下几个关键设计考量，而您提到的 <code>ControlChannel</code> 构造函数中的 D-Bus 注册逻辑正是这一设计的具体体现。以下是详细分析：</p>
<hr>
<h3 id="1-为什么使用-D-Bus？"><a href="#1-为什么使用-D-Bus？" class="headerlink" title="1. 为什么使用 D-Bus？"></a><strong>1. 为什么使用 D-Bus？</strong></h3><h4 id="1-标准化进程间通信（IPC）"><a href="#1-标准化进程间通信（IPC）" class="headerlink" title="(1) 标准化进程间通信（IPC）"></a><strong>(1) 标准化进程间通信（IPC）</strong></h4><ul>
<li><strong>跨语言&#x2F;跨工具兼容性</strong>：<br>D-Bus 是 Linux 桌面环境的 <strong>标准 IPC 机制</strong>，允许不同进程（甚至是不同语言编写的工具）通过统一的接口通信。Frida 通过 D-Bus 暴露核心功能（如 <code>HostSession</code>），使得第三方工具（如 GUI 调试器、自动化脚本）无需依赖 Frida 的私有协议，直接通过 D-Bus 调用功能。<ul>
<li><strong>例如</strong>：一个 Python 脚本可以通过 <code>dbus-python</code> 库直接调用 Frida 的 <code>attach()</code> 方法。</li>
</ul>
</li>
</ul>
<h4 id="2-模块化与接口分离"><a href="#2-模块化与接口分离" class="headerlink" title="(2) 模块化与接口分离"></a><strong>(2) 模块化与接口分离</strong></h4><ul>
<li><strong>清晰的职责划分</strong>：<br>D-Bus 的接口（如 <code>HostSession</code>、<code>TransportBroker</code>）强制将功能模块化，每个接口对应一组明确的操作。例如：<ul>
<li><code>HostSession</code>：进程管理（附加、启动、枚举）。</li>
<li><code>TransportBroker</code>：文件传输。</li>
<li><code>AuthenticationService</code>：认证逻辑。<br>这种分离使得代码更易维护和扩展。</li>
</ul>
</li>
</ul>
<h4 id="3-动态服务发现"><a href="#3-动态服务发现" class="headerlink" title="(3) 动态服务发现"></a><strong>(3) 动态服务发现</strong></h4><ul>
<li><strong>无需硬编码配置</strong>：<br>D-Bus 支持服务动态注册和发现。当 Frida 启动时，客户端可以通过 D-Bus 的 <code>ListNames</code> 方法自动发现可用的 <code>re.frida.HostSession</code> 服务，无需预先知道服务的具体地址或端口。</li>
</ul>
<h4 id="4-平台集成（Linux-桌面）"><a href="#4-平台集成（Linux-桌面）" class="headerlink" title="(4) 平台集成（Linux 桌面）"></a><strong>(4) 平台集成（Linux 桌面）</strong></h4><ul>
<li><strong>与系统深度集成</strong>：<br>在 Linux 桌面环境中，许多系统服务（如网络、硬件管理）本身通过 D-Bus 暴露接口。Frida 使用 D-Bus 可以更方便地与这些服务交互（例如通过脚本监控网络状态）。<ul>
<li>[逆向与风控, Android平台, 逆向, Hook技术, Frida]</li>
</ul>
</li>
</ul>
<hr>
<h3 id="2-为什么在-ControlChannel-中注册-D-Bus-接口？"><a href="#2-为什么在-ControlChannel-中注册-D-Bus-接口？" class="headerlink" title="2. 为什么在 ControlChannel 中注册 D-Bus 接口？"></a><strong>2. 为什么在 <code>ControlChannel</code> 中注册 D-Bus 接口？</strong></h3><p>您提到的代码是 <code>ControlChannel</code> 的构造函数，其核心目的是 <strong>将 Frida 的核心功能暴露为 D-Bus 服务</strong>。具体来说：</p>
<h4 id="1-注册-HostSession-接口"><a href="#1-注册-HostSession-接口" class="headerlink" title="(1) 注册 HostSession 接口"></a><strong>(1) 注册 <code>HostSession</code> 接口</strong></h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vala">registrations.add (connection.register_object (ObjectPath.HOST_SESSION, <span class="hljs-keyword">this</span>));<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>作用</strong>：<br>允许客户端通过 D-Bus 调用进程管理方法（如 <code>attach</code>、<code>spawn</code>）。例如：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Python 客户端通过 D-Bus 调用</span><br>session = bus.get_object(<span class="hljs-string">&#x27;re.frida.HostSession&#x27;</span>, <span class="hljs-string">&#x27;/re/frida/HostSession&#x27;</span>)<br>session.attach(pid)  <span class="hljs-comment"># 附加到目标进程</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="2-注册-TransportBroker-接口"><a href="#2-注册-TransportBroker-接口" class="headerlink" title="(2) 注册 TransportBroker 接口"></a><strong>(2) 注册 <code>TransportBroker</code> 接口</strong></h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vala">registrations.add (connection.register_object (Frida.ObjectPath.TRANSPORT_BROKER, <span class="hljs-keyword">this</span>));<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>作用</strong>：<br>处理大文件传输（如上传动态库或脚本文件），通过 D-Bus 标准化数据传输的流程。</li>
</ul>
<h4 id="3-注册空认证服务"><a href="#3-注册空认证服务" class="headerlink" title="(3) 注册空认证服务"></a><strong>(3) 注册空认证服务</strong></h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vala">registrations.add (connection.register_object (Frida.ObjectPath.AUTHENTICATION_SERVICE, <span class="hljs-keyword">new</span> NullAuthenticationService ()));<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>设计意图</strong>：<br>即使当前无需认证，也保留接口一致性。未来若需启用认证（如 Token 或 TLS），为 <code>TokenAuthenticationService</code>，而无需修改客户端代码。</li>
</ul>
<hr>
<h3 id="3-D-Bus-vs-自定义协议"><a href="#3-D-Bus-vs-自定义协议" class="headerlink" title="3. D-Bus vs 自定义协议"></a><strong>3. D-Bus vs 自定义协议</strong></h3><p>Frida 的核心通信（如 <code>frida-server</code> ↔ <code>frida-agent</code>）使用 <strong>自定义二进制协议</strong>（基于 TCP&#x2F;共享内存），但在以下场景选择 D-Bus：</p>
<table>
<thead>
<tr>
<th><strong>场景</strong></th>
<th><strong>协议选择</strong></th>
<th><strong>原因</strong></th>
</tr>
</thead>
<tbody><tr>
<td>客户端 ↔ <code>frida-server</code>（Linux）</td>
<td>D-Bus</td>
<td>方便与桌面工具集成，支持多语言调用</td>
</tr>
<tr>
<td>客户端 ↔ <code>frida-server</code>（Android）</td>
<td>自定义 TCP 协议</td>
<td>Android 无 D-Bus 服务，且需要更高性能</td>
</tr>
<tr>
<td><code>frida-server</code> ↔ <code>frida-agent</code></td>
<td>共享内存&#x2F;Unix Socket</td>
<td>高频操作需低延迟，D-Bus 序列化开销过大</td>
</tr>
</tbody></table>
<ul>
<li>[逆向与风控, Android平台, 逆向, Hook技术, Frida]</li>
</ul>
<hr>
<h3 id="4-实际案例：Frida-的-D-Bus-使用"><a href="#4-实际案例：Frida-的-D-Bus-使用" class="headerlink" title="4. 实际案例：Frida 的 D-Bus 使用"></a><strong>4. 实际案例：Frida 的 D-Bus 使用</strong></h3><h4 id="1-服务注册流程"><a href="#1-服务注册流程" class="headerlink" title="(1) 服务注册流程"></a><strong>(1) 服务注册流程</strong></h4><pre><code class=" mermaid">sequenceDiagram
    participant Client
    participant D-Bus Daemon
    participant Frida (ControlChannel)

    Client-&gt;&gt;D-Bus Daemon: 查询服务列表 (ListNames)
    D-Bus Daemon-&gt;&gt;Client: 返回 [&quot;re.frida.HostSession&quot;]
    Client-&gt;&gt;Frida: D-Bus 调用 HostSession.attach()
    Frida-&gt;&gt;Client: 返回进程句柄
</code></pre>

<h4 id="2-性能优化"><a href="#2-性能优化" class="headerlink" title="(2) 性能优化"></a><strong>(2) 性能优化</strong></h4><ul>
<li><strong>仅限必要操作</strong>：D-Bus 用于低频控制命令（如启动&#x2F;附加进程），而 Hook 数据传输走自定义协议。</li>
<li><strong>接口轻量化</strong>：<code>HostSession</code> 接口仅暴露方法调用，不涉及大数据传输。</li>
</ul>
<hr>
<h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a><strong>5. 总结</strong></h3><p>Frida 使用 D-Bus 的主要原因包括：</p>
<ol>
<li><strong>标准化接口</strong>：便于与 Linux 生态工具集成。</li>
<li><strong>模块化设计</strong>：通过接口分离功能（如 <code>HostSession</code> vs <code>TransportBroker</code>）。</li>
<li><strong>动态服务发现</strong>：客户端无需硬编码配置。</li>
<li><strong>兼容性</strong>：为未来扩展（如认证）预留接口。</li>
</ol>
<p>在 Android 或高性能场景中，Frida 仍优先使用自定义协议，而 D-Bus 是 <strong>对特定平台（Linux）和场景（工具集成）的优化选择</strong>。</p>
<p>在讨论 <strong>D-Bus</strong> 作为 <strong>Linux 桌面环境的 IPC 标准</strong>时，强调“桌面环境”是为了区分其设计目标和主要应用场景。与普通 Linux 下的其他 IPC 机制相比，D-Bus 在 <strong>功能定位、使用场景和设计哲学</strong> 上有显著差异。以下是详细对比分析：</p>
<ul>
<li>[逆向与风控, Android平台, 逆向, Hook技术, Frida]</li>
</ul>
<hr>
<h3 id="1-D-Bus-的“桌面环境”属性"><a href="#1-D-Bus-的“桌面环境”属性" class="headerlink" title="1. D-Bus 的“桌面环境”属性"></a><strong>1. D-Bus 的“桌面环境”属性</strong></h3><h4 id="1-设计目标"><a href="#1-设计目标" class="headerlink" title="(1) 设计目标"></a><strong>(1) 设计目标</strong></h4><ul>
<li><p><strong>为桌面应用而生</strong>：<br>D-Bus 最初是为 <strong>GNOME&#x2F;KDE 等桌面环境</strong> 设计的，核心目标是解决桌面组件（如窗口管理器、音量控制、网络设置）之间的通信需求。  </p>
<ul>
<li><strong>典型用例</strong>：  <ul>
<li>用户点击音量按钮 → 通过 D-Bus 通知音频服务调整音量。  </li>
<li>文件管理器需要挂载磁盘 → 通过 D-Bus 调用 <code>udisks2</code> 服务。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>强调易用性和动态性</strong>：  </p>
<ul>
<li>支持 <strong>服务发现</strong>（动态注册）。  </li>
<li>提供 <strong>高级抽象</strong>（如对象路径、接口、方法调用），开发者无需直接操作底层 IPC（如共享内存或信号量）。</li>
</ul>
</li>
</ul>
<h4 id="2-与普通-Linux-IPC-的对比"><a href="#2-与普通-Linux-IPC-的对比" class="headerlink" title="(2) 与普通 Linux IPC 的对比"></a><strong>(2) 与普通 Linux IPC 的对比</strong></h4><table>
<thead>
<tr>
<th><strong>特性</strong></th>
<th><strong>D-Bus（桌面环境）</strong></th>
<th><strong>普通 Linux IPC</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>主要用途</strong></td>
<td>桌面组件通信、用户交互</td>
<td>系统级进程通信（如 daemon、高性能服务）</td>
</tr>
<tr>
<td><strong>通信模式</strong></td>
<td>基于消息（异步&#x2F;同步）</td>
<td>多样化（管道、消息队列、共享内存、Socket）</td>
</tr>
<tr>
<td><strong>抽象层级</strong></td>
<td>高级（对象&#x2F;接口&#x2F;方法）</td>
<td>低级（字节流、信号、文件描述符）</td>
</tr>
<tr>
<td><strong>服务发现</strong></td>
<td>支持（通过总线名称）</td>
<td>需手动实现（如配置文件或固定路径）</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>较高延迟（适合低频操作）</td>
<td>极高（适合高频数据传输）</td>
</tr>
<tr>
<td><strong>典型用户</strong></td>
<td>GUI 应用、系统服务（如 NetworkManager）</td>
<td>后台服务、嵌入式系统、内核模块</td>
</tr>
</tbody></table>
<hr>
<h3 id="2-为什么普通-Linux-环境可能不用-D-Bus？"><a href="#2-为什么普通-Linux-环境可能不用-D-Bus？" class="headerlink" title="2. 为什么普通 Linux 环境可能不用 D-Bus？"></a><strong>2. 为什么普通 Linux 环境可能不用 D-Bus？</strong></h3><h4 id="1-性能开销"><a href="#1-性能开销" class="headerlink" title="(1) 性能开销"></a><strong>(1) 性能开销</strong></h4><ul>
<li><strong>序列化成本</strong>：D-Bus 使用 <strong>XML 或二进制协议</strong> 封装消息，适合低频控制命令，但不如直接使用 <code>共享内存</code> 或 <code>Unix Socket</code> 高效。  <ul>
<li><strong>示例</strong>：  <ul>
<li>高频数据传输（如视频流）通常选择 <code>共享内存</code> 或 <code>RDMA</code>。  </li>
<li>内核与用户态通信（如 <code>netlink</code>）直接绕过 D-Bus。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="2-依赖复杂性"><a href="#2-依赖复杂性" class="headerlink" title="(2) 依赖复杂性"></a><strong>(2) 依赖复杂性</strong></h4><ul>
<li><strong>额外守护进程</strong>：D-Bus 需要 <code>dbus-daemon</code> 作为消息总线，增加了系统复杂度。  <ul>
<li><strong>嵌入式 Linux</strong> 可能禁用 D-Bus 以减少资源占用。</li>
</ul>
</li>
</ul>
<h4 id="3-功能冗余"><a href="#3-功能冗余" class="headerlink" title="(3) 功能冗余"></a><strong>(3) 功能冗余</strong></h4><ul>
<li><strong>简单场景无需高级抽象</strong>：若仅需两个进程交换数据，直接用 <code>管道</code> 或 <code>Socket</code> 更轻量。  <ul>
<li><strong>示例</strong>：  <ul>
<li><code>cron</code> 调用脚本通过 <code>管道</code> 传递参数，无需 D-Bus。</li>
</ul>
</li>
<li>[逆向与风控, Android平台, 逆向, Hook技术, Frida]</li>
</ul>
</li>
</ul>
<hr>
<h3 id="3-D-Bus-在-Frida-中的特殊角色"><a href="#3-D-Bus-在-Frida-中的特殊角色" class="headerlink" title="3. D-Bus 在 Frida 中的特殊角色"></a><strong>3. D-Bus 在 Frida 中的特殊角色</strong></h3><p>Frida 在 <strong>Linux 桌面环境</strong> 下使用 D-Bus 的原因：</p>
<h4 id="1-与桌面工具集成"><a href="#1-与桌面工具集成" class="headerlink" title="(1) 与桌面工具集成"></a><strong>(1) 与桌面工具集成</strong></h4><ul>
<li><strong>场景</strong>：Frida 的 GUI 调试器（如 <a target="_blank" rel="noopener" href="https://github.com/frida/frida-gum">frida-gui</a>）需要与桌面环境交互（如弹出对话框、通知状态）。  </li>
<li><strong>实现</strong>：通过 D-Bus 调用 <code>org.freedesktop.Notifications</code> 服务显示#### <strong>(2) 标准化接口</strong></li>
<li><strong>优势</strong>：D-Bus 的接口描述语言（如 <code>.service</code> 文件）允许 Frida 暴露统一的 <code>HostSession</code> API，供不同语言（Python、C、JS）调用。  <ul>
<li><strong>对比</strong>：若用自定义协议，需为每种语言实现客户端库。</li>
</ul>
</li>
</ul>
<h4 id="3-动态服务管理"><a href="#3-动态服务管理" class="headerlink" title="(3) 动态服务管理"></a><strong>(3) 动态服务管理</strong></h4><ul>
<li><strong>用例</strong>：当 Frida 的 <code>frida-server</code> 启动时，自动在 D-Bus 总线上注册服务，客户端无需预知服务地址。</li>
</ul>
<hr>
<h3 id="4-其他-Linux-IPC-机制的适用场景"><a href="#4-其他-Linux-IPC-机制的适用场景" class="headerlink" title="4. 其他 Linux IPC 机制的适用场景"></a><strong>4. 其他 Linux IPC 机制的适用场景</strong></h3><table>
<thead>
<tr>
<th><strong>IPC 机制</strong></th>
<th><strong>典型应用场景</strong></th>
<th><strong>为何不用于桌面？</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Unix Domain Socket</strong></td>
<td>Docker 守护进程、数据库（如 Redis）</td>
<td>需手动管理连接，无服务发现</td>
</tr>
<tr>
<td><strong>共享内存</strong></td>
<td>高频数据传输（如游戏引擎）</td>
<td>需同步机制（如信号量），开发复杂度高</td>
</tr>
<tr>
<td><strong>管道</strong></td>
<td>Shell 脚本链式调用（<code>ls | grep</code>）</td>
<td>仅单向通信，无结构化消息</td>
</tr>
<tr>
<td><strong>信号</strong></td>
<td>进程控制 <code>kill -9</code>）</td>
<td>无法传递复杂数据</td>
</tr>
</tbody></table>
<ul>
<li>[逆向与风控, Android平台, 逆向, Hook技术, Frida]</li>
</ul>
<hr>
<h3 id="5-代码示例：D-Bus-vs-Unix-Socket"><a href="#5-代码示例：D-Bus-vs-Unix-Socket" class="headerlink" title="5. 代码示例：D-Bus vs Unix Socket"></a><strong>5. 代码示例：D-Bus vs Unix Socket</strong></h3><h4 id="1-D-Bus-服务注册（Frida-风格）"><a href="#1-D-Bus-服务注册（Frida-风格）" class="headerlink" title="(1) D-Bus 服务注册（Frida 风格）"></a><strong>(1) D-Bus 服务注册（Frida 风格）</strong></h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-comment">// 注册 HostSession 接口到 D-Bus</span><br>registrations.add (connection.register_object (<span class="hljs-string">&quot;/re/frida/HostSession&quot;</span>, <span class="hljs-keyword">this</span>));<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>优势</strong>：客户端只需知道总线名称（<code>re.frida.HostSession</code>），无需关心具体路径。</li>
</ul>
<h4 id="2-Unix-Socket-实现同类功能"><a href="#2-Unix-Socket-实现同类功能" class="headerlink" title="(2) Unix Socket 实现同类功能"></a><strong>(2) Unix Socket 实现同类功能</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 服务端监听 Socket</span><br><span class="hljs-type">int</span> sock = socket(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>);<br>bind(sock, <span class="hljs-string">&quot;/tmp/frida.sock&quot;</span>);<br>listen(sock, <span class="hljs-number">5</span>);<br><span class="hljs-comment">// 客户端需硬编码路径 &quot;/tmp/frida.sock&quot;</span><br></code></pre></td></tr></table></figure>
<ul>
<li><strong>缺点</strong>：路径固定，无法动态发现服务。</li>
</ul>
<hr>
<h3 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a><strong>6. 总结</strong></h3><ul>
<li><strong>强调“桌面环境”</strong>：<br>D-Bus 的设计优先考虑 <strong>桌面应用的交互需求</strong>（如易用性、动态性），而非极致性能或系统级通信。  </li>
<li><strong>Frida 的选择</strong>：<br>在 Linux 桌面环境下，D-Bus 提供了 <strong>标准化、可扩展的 IPC 接口</strong>，但在 Android 或高性能场景中，Frida 仍会使用自定义协议。  </li>
<li><strong>其他 IPC 的适用性</strong>：<br>根据场景选择工具——简单通信用管道，高频数据用共享内存，桌面交互用 D-Bus。</li>
</ul>
<p>两种模式的区别？</p>
<p>frida-agent是被注入的？是如何hook java层和native层函数的？</p>
<pre><code class=" mermaid">sequenceDiagram
    participant Client as frida-client
    participant Server as frida-server
    participant Helper as frida-helper (root)
    participant Target as 目标进程
    participant Agent as frida-agent.so
    participant Gum as frida-gum.so

    Client-&gt;&gt;Server: attach(pid)
    Server-&gt;&gt;Helper: D-Bus 调用 (InjectLibrary)
    
    alt 外部预检查
        Helper-&gt;&gt;Target: 读取 /proc/pid/status 的 TracerPid
        Helper--xClient: 若 TracerPid ≠ 0，直接返回错误
    else 注入流程
        Helper-&gt;&gt;Target: ptrace(PTRACE_ATTACH)
        Target--&gt;&gt;Helper: 暂停执行 (SIGSTOP)
        Helper-&gt;&gt;Target: 注入 frida-agent.so
        Target-&gt;&gt;Agent: 加载并初始化
        Agent-&gt;&gt;Gum: 调用 gum_process_is_debugger_attached()
        alt 内部最终确认
            Gum--xAgent: 若 TracerPid ≠ 0，卸载并返回错误
        else 继续执行
            Gum-&gt;&gt;Target: Hook 目标函数
            Agent--&gt;&gt;Helper: 返回成功
        end
    end

    Helper--&gt;&gt;Server: 操作结果
    Server--&gt;&gt;Client: 建立通信
</code></pre>



<pre><code class=" mermaid">sequenceDiagram
    participant Client as frida-client
    participant Server as frida-server
    participant Helper as frida-helper
    participant NewProc as 新进程 (挂起)
    participant Agent as frida-agent.so
    participant Gum as frida-gum.so

    Client-&gt;&gt;Server: spawn(path, options)
    Server-&gt;&gt;Helper: D-Bus 调用 (Spawn)
    
    Helper-&gt;&gt;NewProc: fork() + execve(path) → 进程暂停
    Helper-&gt;&gt;NewProc: ptrace(PTRACE_TRACEME)
    Helper-&gt;&gt;NewProc: 注入 frida-agent.so (避免 ld.so 检测)
    NewProc-&gt;&gt;Agent: 加载并初始化
    Agent-&gt;&gt;Gum: 早期 Hook (如 RegisterNative)
    Agent--&gt;&gt;Helper: 就绪信号
    Helper-&gt;&gt;NewProc: ptrace(PTRACE_CONT)
    Helper--&gt;&gt;Server: 返回新进程 PID
    Server--&gt;&gt;Client: 建立通信
</code></pre>

<ol>
<li><p>attach模式<br>attach到已经存在的进程，核心原理是ptrace修改进程内存，如果进程处于调试状态（traceid不等于0），则attach失败。</p>
<p>frida 的进程注入是通过 ptrace 实现的，注入之后会在远端进程分配一段内存将 agent 拷贝过去并在目标进程中执行代码，执行完成后会 detach 目标进程。</p>
<p>这也是为什么在 frida 先连接上目标进程后还可以用 gdb 等调试器连接，而先 gdb 连接进程后 frida 就无法再次连上的原因。</p>
<p><code>frida-agent</code> 注入到目标进程并启动后会启动一个新进程与 host 进行通信，从而 host 可以给目标进行发送命令，比如执行代码，激活&#x2F;关闭 hook，同时也能接收到目标进程的执行返回以及异步事件信息等。</p>
</li>
<li><p>spawn模式<br>启动一个新的进程并挂起，在启动的同时注入frida代码，适用于在进程启动前的一些hook，如hook RegisterNative等，注入完成后调用resume恢复进程。</p>
</li>
</ol>
<p>注入逻辑</p>
<pre><code class=" mermaid">sequenceDiagram
    participant Helper as frida-helper (root)
    participant Target as 目标进程
    participant Bootstrapper as 引导代码
    participant Agent as frida-agent.so

    Helper-&gt;&gt;Target: 1. 分配可执行内存 (mmap)
    Helper-&gt;&gt;Target: 2. 写入引导代码 (process_vm_writev)
    Helper-&gt;&gt;Target: 3. 设置调用参数 (寄存器/栈)
    Helper-&gt;&gt;Target: 4. 触发远程执行 (PTRACE_CONT)
    Target-&gt;&gt;Bootstrapper: 5. 执行引导代码
    Bootstrapper-&gt;&gt;Target: 6. 加载 frida-agent.so (避免直接dlopen)
    Bootstrapper--&gt;&gt;Helper: 7. 返回状态
    Helper-&gt;&gt;Agent: 8. 初始化通信通道
</code></pre>

<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">private async <span class="hljs-keyword">BootstrapResult </span><span class="hljs-keyword">bootstrap </span>(size_t loader_size, Cancellable? cancellable) throws Error, IOError &#123;<br>			var result = new <span class="hljs-keyword">BootstrapResult </span>();<br><br>			unowned uint8[] <span class="hljs-keyword">bootstrapper_code </span>= Frida<span class="hljs-meta">.Data</span>.HelperBackend.get_bootstrapper_bin_blob ()<span class="hljs-meta">.data</span>;<br>			size_t <span class="hljs-keyword">bootstrapper_size </span>= round_size_to_page_size (<span class="hljs-keyword">bootstrapper_code.length);</span><br><span class="hljs-keyword"></span><br>			uint64 allocation_base = <span class="hljs-number">0</span>;<br>			size_t allocation_size = size_t.max (<span class="hljs-keyword">bootstrapper_size, </span>loader_size);<br><br>			uint64 remote_mmap = <span class="hljs-number">0</span>;<br>			uint64 remote_munmap = <span class="hljs-number">0</span>;<br>			ProcMapsEntry? remote_libc = ProcMapsEntry.find_by_path (pid, local_libc.path);<br>			<span class="hljs-keyword">bool </span>same_libc = remote_libc != null &amp;&amp; remote_libc.identity == local_libc.identity;<br>			if (same_libc) &#123;<br>				remote_mmap = remote_libc.<span class="hljs-keyword">base_address </span>+ mmap_offset;<br>				remote_munmap = remote_libc.<span class="hljs-keyword">base_address </span>+ munmap_offset;<br>			&#125;<br><br>			if (remote_mmap != <span class="hljs-number">0</span>) &#123;<br>				allocation_base = yield allocate_memory (remote_mmap, allocation_size,<br>					Posix.PROT_READ <span class="hljs-title">| Posix.PROT_WRITE |</span> Posix.PROT_EXEC, cancellable);<br>			&#125; else &#123;<br>				var code_swap = yield new ProcessCodeSwapScope (this, <span class="hljs-keyword">bootstrapper_code, </span>cancellable);<br>				uint64 code_start = code_swap.code_start;<br>				uint64 code_end = code_start + <span class="hljs-keyword">bootstrapper_size;</span><br><span class="hljs-keyword"></span>				maybe_fixup_helper_code (code_start, <span class="hljs-keyword">bootstrapper_code);</span><br><span class="hljs-keyword"></span><br>				var call_builder = new RemoteCallBuilder (code_start, saved_regs);<br><br>				uint64 <span class="hljs-keyword">bootstrap_ctx_location;</span><br><span class="hljs-keyword"></span>				call_builder.reserve_stack_space (sizeof (HelperBootstrapContext), out <span class="hljs-keyword">bootstrap_ctx_location);</span><br><span class="hljs-keyword"></span><br>				var <span class="hljs-keyword">bootstrap_ctx </span>= HelperBootstrapContext ();<br>				<span class="hljs-keyword">bootstrap_ctx.allocation_size </span>= allocation_size;<br>				write_memory (<span class="hljs-keyword">bootstrap_ctx_location, </span>(uint8[]) &amp;<span class="hljs-keyword">bootstrap_ctx);</span><br><span class="hljs-keyword"></span><br>				call_builder.<span class="hljs-keyword">add_argument </span>(<span class="hljs-keyword">bootstrap_ctx_location);</span><br><span class="hljs-keyword"></span><br>				RemoteCallResult <span class="hljs-keyword">bootstrap_result </span>= yield call_builder.<span class="hljs-keyword">build </span>(this).execute (cancellable);<br>				var status = (HelperBootstrapStatus) <span class="hljs-keyword">bootstrap_result.return_value;</span><br><span class="hljs-keyword"></span>				if (<span class="hljs-keyword">bootstrap_result.status </span>!= COMPLETED <span class="hljs-title">||</span> status != ALLOCATION_SUCCESS)<br>					throw_bootstrap_error (<span class="hljs-keyword">bootstrap_result, </span>status, code_start, code_end);<br><br>				uint8[] output_context = read_memory (<span class="hljs-keyword">bootstrap_ctx_location, </span>sizeof (HelperBootstrapContext));<br>				Memory.copy (&amp;<span class="hljs-keyword">bootstrap_ctx, </span>output_context, output_context.length);<br><br>				allocation_base = (uintptr) <span class="hljs-keyword">bootstrap_ctx.allocation_base;</span><br><span class="hljs-keyword"></span><br>				code_swap.revert ();<br>			&#125;<br><br>			try &#123;<br>				write_memory (allocation_base, <span class="hljs-keyword">bootstrapper_code);</span><br><span class="hljs-keyword"></span>				maybe_fixup_helper_code (allocation_base, <span class="hljs-keyword">bootstrapper_code);</span><br><span class="hljs-keyword"></span>				uint64 code_start = allocation_base;<br>				uint64 code_end = code_start + <span class="hljs-keyword">bootstrapper_size;</span><br><span class="hljs-keyword"></span><br>				HelperBootstrapStatus status = SUCCESS;<br>				do &#123;<br>					var call_builder = new RemoteCallBuilder (code_start, saved_regs);<br><br>					unowned uint8[] fallback_ld_data = fallback_ld<span class="hljs-meta">.data</span>;<br>					unowned uint8[] fallback_libc_data = fallback_libc<span class="hljs-meta">.data</span>;<br><br>					uint64 libc_api_location, <span class="hljs-keyword">bootstrap_ctx_location, </span>fallback_ld_location, fallback_libc_location;<br>					call_builder<br>						.reserve_stack_space (sizeof (HelperLibcApi), out libc_api_location)<br>						.reserve_stack_space (sizeof (HelperBootstrapContext), out <span class="hljs-keyword">bootstrap_ctx_location)</span><br><span class="hljs-keyword"></span>						.reserve_stack_space (fallback_ld_data.length + <span class="hljs-number">1</span>, out fallback_ld_location)<br>						.reserve_stack_space (fallback_libc_data.length + <span class="hljs-number">1</span>, out fallback_libc_location);<br><br>					var <span class="hljs-keyword">bootstrap_ctx </span>= HelperBootstrapContext ();<br>					<span class="hljs-keyword">bootstrap_ctx.allocation_base </span>= (void *) allocation_base;<br>					<span class="hljs-keyword">bootstrap_ctx.allocation_size </span>= allocation_size;<br>					<span class="hljs-keyword">bootstrap_ctx.page_size </span>= Gum.query_page_size ();<br>					<span class="hljs-keyword">bootstrap_ctx.fallback_ld </span>= (string *) fallback_ld_location;<br>					<span class="hljs-keyword">bootstrap_ctx.fallback_libc </span>= (string *) fallback_libc_location;<br>					<span class="hljs-keyword">bootstrap_ctx.enable_ctrlfds </span>= PidFileDescriptor.getfd_is_supported ();<br>					<span class="hljs-keyword">bootstrap_ctx.libc </span>= (HelperLibcApi *) libc_api_location;<br>					write_memory (<span class="hljs-keyword">bootstrap_ctx_location, </span>(uint8[]) &amp;<span class="hljs-keyword">bootstrap_ctx);</span><br><span class="hljs-keyword"></span>					unowned uint8[] fallback_ld_cstr = fallback_ld_data[:fallback_ld_data.length + <span class="hljs-number">1</span>];<br>					unowned uint8[] fallback_libc_cstr = fallback_libc_data[:fallback_libc_data.length + <span class="hljs-number">1</span>];<br>					write_memory (fallback_ld_location, fallback_ld_cstr);<br>					write_memory (fallback_libc_location, fallback_libc_cstr);<br>					call_builder.<span class="hljs-keyword">add_argument </span>(<span class="hljs-keyword">bootstrap_ctx_location);</span><br><span class="hljs-keyword"></span><br>					RemoteCall <span class="hljs-keyword">bootstrap_call </span>= call_builder.<span class="hljs-keyword">build </span>(this);<br>					RemoteCallResult <span class="hljs-keyword">bootstrap_result </span>= yield <span class="hljs-keyword">bootstrap_call.execute </span>(cancellable);<br>					status = (HelperBootstrapStatus) <span class="hljs-keyword">bootstrap_result.return_value;</span><br><span class="hljs-keyword"></span><br>					<span class="hljs-keyword">bool </span>restart_after_libc_load =<br>						<span class="hljs-keyword">bootstrap_result.status </span>== RAISED_SIGNAL &amp;&amp; <span class="hljs-keyword">bootstrap_result.stop_signal </span>== Posix.Signal.STOP;<br>					if (restart_after_libc_load) &#123;<br>						<span class="hljs-keyword">bootstrap_result </span>= yield <span class="hljs-keyword">bootstrap_call.execute </span>(cancellable);<br>						status = (HelperBootstrapStatus) <span class="hljs-keyword">bootstrap_result.return_value;</span><br><span class="hljs-keyword"></span>					&#125;<br><br>					if (!(<span class="hljs-keyword">bootstrap_result.status </span>== COMPLETED &amp;&amp; (status == SUCCESS <span class="hljs-title">||</span> status == TOO_EARLY)))<br>						throw_bootstrap_error (<span class="hljs-keyword">bootstrap_result, </span>status, code_start, code_end);<br><br>					uint8[] output_context = read_memory (<span class="hljs-keyword">bootstrap_ctx_location, </span>sizeof (HelperBootstrapContext));<br>					Memory.copy (&amp;result.context, output_context, output_context.length);<br><br>					uint8[] output_libc = read_memory (libc_api_location, sizeof (HelperLibcApi));<br>					Memory.copy (&amp;result.libc, output_libc, output_libc.length);<br><br>					result.context.libc = &amp;result.libc;<br><br>					if (result.context.rtld_flavor == <span class="hljs-keyword">ANDROID </span>&amp;&amp; result.libc.dlopen == null) &#123;<br>						ProcMapsEntry? remote_ld = ProcMapsEntry.find_by_address (pid, (uintptr) result.context.rtld_base);<br>						<span class="hljs-keyword">bool </span>same_ld = remote_ld != null &amp;&amp; local_android_ld != null &amp;&amp; remote_ld.identity == local_android_ld.identity;<br>						if (!same_ld)<br>							throw new Error.NOT_SUPPORTED (<span class="hljs-string">&quot;Unable to locate Android dynamic linker; please file a bug&quot;</span>);<br>						result.libc.dlopen = rebase_pointer ((uintptr) dlopen, local_android_ld, remote_ld);<br>						result.libc.dlclose = rebase_pointer ((uintptr) dlclose, local_android_ld, remote_ld);<br>						result.libc.dlsym = rebase_pointer ((uintptr) dlsym, local_android_ld, remote_ld);<br>						result.libc.dlerror = rebase_pointer ((uintptr) dlerror, local_android_ld, remote_ld);<br>					&#125;<br><br>					if (status == TOO_EARLY)<br>						yield resume_until_execution_reaches ((uintptr) result.context.r_brk, cancellable);<br>				&#125; while (status == TOO_EARLY);<br>			&#125; catch (GLib.Error e) &#123;<br>				if (remote_munmap != <span class="hljs-number">0</span>) &#123;<br>					try &#123;<br>						yield deallocate_memory (remote_munmap, allocation_base, allocation_size, null);<br>					&#125; catch (GLib.Error e) &#123;<br>					&#125;<br>				&#125;<br><br>				throw_api_error (e);<br>			&#125;<br><br>			return result;<br>		&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process_tasks</span> (<span class="hljs-params">Gee.Queue&lt;TaskEntry&gt; queue, <span class="hljs-built_in">uint</span> pid</span>)</span> &#123;<br>			<span class="hljs-comment">// 获取主线程上下文</span><br>			<span class="hljs-keyword">var</span> main_context = MainContext.get_thread_default ();<br><br>			<span class="hljs-comment">// 从队列中取出任务</span><br>			TaskEntry entry;<br>			<span class="hljs-keyword">while</span> ((entry = queue.poll ()) != <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-keyword">try</span> &#123;<br>					<span class="hljs-comment">// 如果任务被取消，则设置错误</span><br>					entry.cancellable.set_error_if_cancelled ();<br>					<span class="hljs-comment">// 运行任务，并获取结果</span><br>					<span class="hljs-keyword">var</span> result = <span class="hljs-keyword">yield</span> entry.task.run (pid, entry.cancellable);<br>					<span class="hljs-comment">// 解析任务结果</span><br>					entry.promise.resolve (result);<br>				&#125; <span class="hljs-keyword">catch</span> (GLib.Error e) &#123;<br>					<span class="hljs-comment">// 如果任务出错，则拒绝任务</span><br>					entry.promise.reject (e);<br>				&#125;<br><br>				<span class="hljs-comment">// 创建一个空闲源</span><br>				<span class="hljs-keyword">var</span> source = <span class="hljs-keyword">new</span> IdleSource ();<br>				<span class="hljs-comment">// 设置空闲源的回调函数</span><br>				source.set_callback (process_tasks.callback);<br>				<span class="hljs-comment">// 将空闲源附加到主线程上下文</span><br>				source.attach (main_context);<br>				<span class="hljs-comment">// 等待空闲源触发</span><br>				<span class="hljs-keyword">yield</span>;<br>			&#125;<br>			<span class="hljs-comment">// 从任务队列中移除该进程的任务队列</span><br>			task_queues.unset (pid);<br>		&#125;<br><br></code></pre></td></tr></table></figure>



<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> RemoteAgent <span class="hljs-title">run</span> (<span class="hljs-params"><span class="hljs-built_in">uint</span> pid, Cancellable? cancellable</span>) throws Error, IOError</span> &#123;<br>				PausedSyscallSession? pss = backend.paused_syscalls[pid];<br>				<span class="hljs-keyword">if</span> (pss != <span class="hljs-literal">null</span>)<br>					<span class="hljs-keyword">yield</span> pss.interrupt (cancellable);<br>				<span class="hljs-keyword">var</span> session = <span class="hljs-keyword">yield</span> InjectSession.open (pid, cancellable);<br>				RemoteAgent agent = <span class="hljs-keyword">yield</span> session.inject (spec, cancellable);<br>				session.close ();<br>				<span class="hljs-keyword">return</span> agent;<br>			&#125;<br></code></pre></td></tr></table></figure>

<p>将 <code>frida-agent.so</code>（或自定义 Agent）注入目标进程，并启动其执行，建立调试通道。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> RemoteAgent <span class="hljs-title">inject</span> (<span class="hljs-params">InjectSpec spec, Cancellable? cancellable</span>) throws Error, IOError</span> &#123;<br>			<span class="hljs-built_in">string</span> fallback_address = make_fallback_address ();<br>			LoaderLayout loader_layout = compute_loader_layout (spec, fallback_address);<br><br>			BootstrapResult bootstrap_result = <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-title">bootstrap</span> (<span class="hljs-params">loader_layout.size, cancellable</span>)</span>;<br>			uint64 loader_base = (uintptr) bootstrap_result.context.allocation_base;<br><br>			<span class="hljs-keyword">try</span> &#123;<br>				unowned uint8[] loader_code = Frida.Data.HelperBackend.get_loader_bin_blob ().data;<br>				write_memory (loader_base, loader_code);<br>				maybe_fixup_helper_code (loader_base, loader_code);<br><br>				<span class="hljs-keyword">var</span> loader_ctx = HelperLoaderContext ();<br>				loader_ctx.ctrlfds = bootstrap_result.context.ctrlfds;<br>				loader_ctx.agent_entrypoint = (<span class="hljs-built_in">string</span> *) (loader_base + loader_layout.agent_entrypoint_offset);<br>				loader_ctx.agent_data = (<span class="hljs-built_in">string</span> *) (loader_base + loader_layout.agent_data_offset);<br>				loader_ctx.fallback_address = (<span class="hljs-built_in">string</span> *) (loader_base + loader_layout.fallback_address_offset);<br>				loader_ctx.libc = (HelperLibcApi *) (loader_base + loader_layout.libc_api_offset);<br>				write_memory (loader_base + loader_layout.ctx_offset, (uint8[]) &amp;loader_ctx);<br>				write_memory (loader_base + loader_layout.libc_api_offset, (uint8[]) &amp;bootstrap_result.libc);<br>				write_memory_string (loader_base + loader_layout.agent_entrypoint_offset, spec.entrypoint);<br>				write_memory_string (loader_base + loader_layout.agent_data_offset, spec.data);<br>				write_memory_string (loader_base + loader_layout.fallback_address_offset, fallback_address);<br><br>				<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-title">launch_loader</span> (<span class="hljs-params">FROM_SCRATCH, spec, bootstrap_result, <span class="hljs-literal">null</span>, fallback_address, loader_layout,</span></span><br><span class="hljs-params"><span class="hljs-function">					cancellable</span>)</span>;<br>			&#125; <span class="hljs-keyword">catch</span> (GLib.Error error) &#123;<br>				<span class="hljs-keyword">try</span> &#123;<br>					<span class="hljs-function"><span class="hljs-keyword">yield</span> <span class="hljs-title">deallocate_memory</span> (<span class="hljs-params">(uintptr</span>) bootstrap_result.libc.munmap, loader_base, loader_layout.size,</span><br><span class="hljs-function">						<span class="hljs-literal">null</span>)</span>;<br>				&#125; <span class="hljs-keyword">catch</span> (GLib.Error e) &#123;<br>				&#125;<br><br>				<span class="hljs-keyword">if</span> (error <span class="hljs-keyword">is</span> IOError)<br>					<span class="hljs-keyword">throw</span> (IOError) error;<br>				<span class="hljs-keyword">throw</span> (Error) error;<br>			&#125;<br>		&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h1 id="Hook原理"><a href="#Hook原理" class="headerlink" title="Hook原理"></a>Hook原理</h1><h2 id="内存监控"><a href="#内存监控" class="headerlink" title="内存监控"></a>内存监控</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs"><br></code></pre></td></tr></table></figure>

<h2 id="ArtHook"><a href="#ArtHook" class="headerlink" title="ArtHook"></a>ArtHook</h2><pre><code class=" mermaid">sequenceDiagram
    participant JS as JavaScript
    participant ArtMethod
    participant Trampoline
    participant OriginalCode

    JS-&gt;&gt;ArtMethod: 1. 修改 entry_point_ 为跳板地址
    ArtMethod-&gt;&gt;Trampoline: 2. 调用跳板代码
    Trampoline-&gt;&gt;JS: 3. 执行 JavaScript 回调
    JS-&gt;&gt;Trampoline: 4. 返回控制权
    Trampoline-&gt;&gt;OriginalCode: 5. 跳回原方法
    OriginalCode--&gt;&gt;ArtMethod: 6. 继续执行原逻辑
</code></pre>

<h3 id="hook-java层"><a href="#hook-java层" class="headerlink" title="hook java层"></a><strong>hook java层</strong></h3><h2 id="Interceptor"><a href="#Interceptor" class="headerlink" title="Interceptor"></a>Interceptor</h2><hr>
<p><a target="_blank" rel="noopener" href="https://evilpan.com/2022/04/17/frida-java/#native-api">Frida Internal - Part 3: Java Bridge 与 ART hook - 有价值炮灰</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%80%86%E5%90%91%E4%B8%8E%E9%A3%8E%E6%8E%A7/" class="category-chain-item">逆向与风控</a>
  
  
    <span>></span>
    
  <a href="/categories/%E9%80%86%E5%90%91%E4%B8%8E%E9%A3%8E%E6%8E%A7/Android%E5%B9%B3%E5%8F%B0/" class="category-chain-item">Android平台</a>
  
  
    <span>></span>
    
  <a href="/categories/%E9%80%86%E5%90%91%E4%B8%8E%E9%A3%8E%E6%8E%A7/Android%E5%B9%B3%E5%8F%B0/%E9%80%86%E5%90%91/" class="category-chain-item">逆向</a>
  
  
    <span>></span>
    
  <a href="/categories/%E9%80%86%E5%90%91%E4%B8%8E%E9%A3%8E%E6%8E%A7/Android%E5%B9%B3%E5%8F%B0/%E9%80%86%E5%90%91/Hook%E6%8A%80%E6%9C%AF/" class="category-chain-item">Hook技术</a>
  
  
    <span>></span>
    
  <a href="/categories/%E9%80%86%E5%90%91%E4%B8%8E%E9%A3%8E%E6%8E%A7/Android%E5%B9%B3%E5%8F%B0/%E9%80%86%E5%90%91/Hook%E6%8A%80%E6%9C%AF/Frida/" class="category-chain-item">Frida</a>
  
  

  

  

  

  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div></div>
      <div>http://example.com/2025/05/09/逆向与风控/Android平台/逆向/Hook技术/Frida/Frida原理/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Ling</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年5月9日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/05/09/%E9%80%86%E5%90%91%E4%B8%8E%E9%A3%8E%E6%8E%A7/Android%E5%B9%B3%E5%8F%B0/%E9%80%86%E5%90%91/Hook%E6%8A%80%E6%9C%AF/Frida/Frida%E6%A3%80%E6%B5%8B/" title="">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/05/09/%E9%80%86%E5%90%91%E4%B8%8E%E9%A3%8E%E6%8E%A7/Android%E5%B9%B3%E5%8F%B0/%E9%80%86%E5%90%91/Hook%E6%8A%80%E6%9C%AF/Frida/Frida%E4%BD%BF%E7%94%A8/" title="">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
